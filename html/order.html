<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.js" integrity="sha256-JlqSTELeR4TLqP0OG9dxM7yDPqX1ox/HfgiSLBj8+kM="
        crossorigin="anonymous"></script>
    
    <!-- axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- portone -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>

    <title>Untitle-Project-FE</title>
</head>
<body>
    <h1>주문</h1>

    <ul>
        <li id="id" style="display: none;"></li>
        <li id="title"></li>
        <li id="product"></li>
        <li id="price"></li>
        <li id="buyer_name"></li>
        <li id="buyer_email" style="display: none;"></li>
        <li id="buyer_phone" style="display: none;"></li>
        <li id="buyer_addr" style="display: none;"></li>
    </ul>
    <button onclick="requestPay()">구매하기</button>

    <script type="text/javascript" src="secret_keys.js">
        $(document).ready(() => {
            $.ajax({
                url: "http://localhost:8000/purchases/order/",
                type: "GET",
                headers: { Authorization: `Bearer ${localStorage.getItem("access")}` },
                data: {order_id: localStorage.getItem("order_id")},
                dataType: "json",
                contentType: "application/json",
                crossDomain: true,
                xhrFields: {
                    withCredentials: true
                },
                success: (response) => {
                    $("#id").text(response.id);
                    $("#title").text(response.title);
                    $("#product").text(response.product);
                    $("#price").text(response.price);
                    $("#buyer_name").text(response.buyer_name);
                    $("#buyer_email").text(response.buyer_email);
                    $("#buyer_phone").text(response.buyer_phone);
                    $("#buyer_addr").text(response.buyer_addr);
                },
                error: (error) => {
                    console.log(error);
                }
            });
        });

        var IMP = window.IMP;
        IMP.init("imp85473323");
        function requestPay() {
            MERCHANT_UID = `merchant-${self.crypto.randomUUID()}`;

            $.ajax({
                url: "http://localhost:8000/purchases/prepurchase/",
                type: "POST",
                headers: { Authorization: `Bearer ${localStorage.getItem("access")}` },
                data: JSON.stringify({
                    merchant_uid: MERCHANT_UID,
                    price: $("#price").text(),
                    order_id: $("#id").text(),
                    status: "ready"
                }),
                dataType: "json",
                contentType: "application/json",
                crossDomain: true,
                xhrFields: {
                    withCredentials: true
                },
                success: (response) => {
                    localStorage.setItem("api_token", response.api_token);
                    localStorage.setItem("merchant_uid", response.merchant_uid);
                    localStorage.setItem("price", response.price);
                    localStorage.setItem("status", response.status);
                },
                error: (error) => {
                    console.log(error);
                }
            });

            IMP.request_pay({
                pg: "kcp.store-3d5642f0-c478-4241-b8c3-03395a70373e",
                pay_method: "card",
                merchant_uid: `${self.crypto.randomUUID()}`,     // 백엔드의 DB에 저장할 항목, 결제 위변조 방지를 위한 검증에 사용
                name: $("#product").text(),
                amount: $("#price").text(),
                buyer_email: $("#buyer_email").text(),
                buyer_name: $("#buyer_name").text(),
                buyer_tel: $("#buyer_phone").text(),
                buyer_addr: $("#buyer_addr").text(),
            }, (rsp) => {
                if (rsp.success) {
                    var msg = `결제가 완료되었습니다.\n
                    고유ID: ${rsp.imp_uid}\n
                    상점 거래 ID: ${rsp.merchant_uid}\n
                    결제 금액: ${rsp.paid_amount}\n
                    카드 승인번호: ${rsp.apply_num}\n
                    상태: ${rsp.status}`;

                    $.ajax({
                        url: "http://localhost:8000/purchases/postpurchase/",
                        type: "PUT",
                        headers: { Authorization: `Bearer ${localStorage.getItem("access")}` },
                        data: JSON.stringify({
                            imp_uid: rsp.imp_uid,
                            merchant_uid: MERCHANT_UID,
                            price: $("#price").text(),
                            order_id: $("#id").text(),
                            status: rsp.status
                        }),
                        dataType: "json",
                        contentType: "application/json",
                        crossDomain: true,
                        xhrFields: {
                            withCredentials: true
                        },
                        success: (response) => {
                            console.log(response);
                        },
                        error: (error) => {
                            console.log(error);
                        }
                    });
                } else {
                    var msg = rsp.error_msg;
                }

                alert(msg);
                location.href = "purchase_complete.html";
            });
        }
    </script>
</body>
</html>